<!DOCTYPE html>
<html>
<head>
  <title>DFS Fantasy - Breakaway Rush</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;500;600&display=swap');
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:
      radial-gradient(ellipse at 25% 25%,rgba(220,220,220,.4) 0%,transparent 60%),
      radial-gradient(ellipse at 75% 75%,rgba(192,192,192,.3) 0%,transparent 60%),
      linear-gradient(135deg,#2c3e50 0%,#34495e 25%,#2c3e50 50%,#1a252f 75%,#2c3e50 100%);
      min-height:100vh;color:#fff;position:relative}
    body::before{content:'';position:fixed;inset:0;background:
      repeating-linear-gradient(22.5deg,transparent 0,rgba(255,255,255,.02) 1px,rgba(220,220,220,.06) 2px,rgba(192,192,192,.04) 3px,transparent 4px,transparent 8px);
      pointer-events:none;z-index:1;animation:shimmer 12s ease-in-out infinite}
    @keyframes shimmer{0%,100%{opacity:.6}50%{opacity:.8}}
    .header{text-align:center;padding:40px 20px;background:linear-gradient(135deg,rgba(255,255,255,.1) 0%,rgba(235,235,235,.06) 50%,rgba(255,255,255,.1) 100%);backdrop-filter:blur(20px);border-bottom:2px solid rgba(255,255,255,.15);position:relative;z-index:2}
    .header h1{font-family:'Orbitron',monospace;font-size:2.5rem;margin:0 0 10px;background:linear-gradient(135deg,#fff 0%,#e8e8e8 25%,#fff 50%,#d3d3d3 75%,#fff 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 25px rgba(255,255,255,.3)}
    .main-container{max-width:1400px;margin:0 auto;padding:20px;position:relative;z-index:2;display:grid;grid-template-columns:1fr 350px;gap:30px}
    .lineup-section,.binder-section{backdrop-filter:blur(20px);border-radius:20px;padding:25px;border:2px solid rgba(255,255,255,.2);box-shadow:0 15px 30px rgba(0,0,0,.2)}
    .lineup-section{background:linear-gradient(135deg,rgba(255,255,255,.15) 0%,rgba(235,235,235,.1) 50%,rgba(255,255,255,.15) 100%)}
    .binder-section{background:linear-gradient(135deg,rgba(255,255,255,.12) 0%,rgba(235,235,235,.08) 50%,rgba(255,255,255,.12) 100%)}
    .section-title{font-family:'Orbitron',monospace;font-size:1.5rem;color:#4CAF50;margin-bottom:20px;text-shadow:0 0 10px rgba(76,175,80,.3)}
    .lineup-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:30px}
    .position-slot{background:rgba(255,255,255,.1);border:2px dashed rgba(255,255,255,.3);border-radius:15px;padding:20px;text-align:center;min-height:140px;display:flex;flex-direction:column;justify-content:center;align-items:center;transition:.3s}
    .position-slot.filled{border-color:#4CAF50;background:rgba(76,175,80,.2)}
    .position-slot.drop-zone{border-color:#2196F3;background:rgba(33,150,243,.2);transform:scale(1.02)}
    .position-label{font-family:'Orbitron',monospace;font-weight:700;font-size:1.3rem;color:rgba(255,255,255,.9);margin-bottom:10px}
    .position-hint{font-size:1rem;color:rgba(255,255,255,.6)}
    .wallet-connection,.contest-info{background:rgba(33,150,243,.2);border:1px solid rgba(33,150,243,.3);border-radius:15px;padding:20px;margin-bottom:20px}
    .connect-wallet-btn{width:100%;padding:12px;background:linear-gradient(135deg,#2196F3,#1976D2);color:#fff;border:0;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;font-family:'Orbitron',monospace;margin-bottom:10px}
    .wallet-status{font-size:.9rem;color:rgba(255,255,255,.8)}
    .my-binder{max-height:600px;overflow-y:auto;padding-right:10px}
    .binder-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px}
    .binder-card{background:#fff;border-radius:10px;padding:8px;text-align:center;box-shadow:0 4px 8px rgba(0,0,0,.2);cursor:grab;transition:.2s;position:relative}
    .binder-card:hover{transform:translateY(-3px);box-shadow:0 8px 16px rgba(0,0,0,.3)}
    .binder-card.dragging{opacity:.5;transform:rotate(5deg)}
    .binder-card.staked{opacity:.5;cursor:not-allowed;background:linear-gradient(135deg,rgba(255,0,0,.1),rgba(255,0,0,.05))}
    .binder-card img{width:100%;height:80px;object-fit:cover;border-radius:6px;margin-bottom:5px}
    .binder-card-name{font-size:.8rem;font-weight:700;color:#333;margin-bottom:3px}
    .binder-card-stats{font-size:.7rem;color:#666}
    .power-badge{position:absolute;top:5px;right:5px;background:#FF6B35;color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700}
    .staked-badge{position:absolute;top:5px;left:5px;background:#f44336;color:#fff;border-radius:4px;padding:2px 4px;font-size:.6rem;font-weight:700}
    .submit-lineup{width:100%;padding:15px;background:linear-gradient(135deg,#4CAF50,#45a049);color:#fff;border:0;border-radius:10px;font-size:1.1rem;font-weight:700;cursor:pointer;font-family:'Orbitron',monospace}
    .submit-lineup:disabled{opacity:.5;cursor:not-allowed}
    .lineup-power{text-align:center;margin:20px 0;font-size:1.2rem}
    .total-power{font-family:'Orbitron',monospace;font-size:1.5rem;color:#FFD700;text-shadow:0 0 10px rgba(255,215,0,.5)}
    .debug-section{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:15px;margin-top:20px}
    .debug-title{font-weight:700;color:#FFD700;margin-bottom:10px}
    .debug-content{font-family:monospace;font-size:.8rem;color:rgba(255,255,255,.8);white-space:pre-wrap;word-break:break-all;max-height:200px;overflow-y:auto}
    @media (max-width:1024px){.main-container{grid-template-columns:1fr;gap:20px}.lineup-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:768px){.lineup-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div style="position:fixed;top:20px;left:20px;z-index:1000;">
    <a href="/" style="background:linear-gradient(135deg,#34495e,#2c3e50);color:#fff;padding:12px 20px;border-radius:25px;text-decoration:none;font-family:'Orbitron',monospace;font-weight:600;font-size:14px;box-shadow:0 4px 15px rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.2)">‚Üê HOME</a>
  </div>

  <div class="header">
    <h1>DFS FANTASY LINEUP</h1>
    <p>Build your lineup using the cards you own</p>
  </div>

  <div class="main-container">
    <div class="lineup-section">
      <h2 class="section-title">üèà Your Lineup (1-1-1-1 Format)</h2>

      <div class="contest-info">
        <div class="contest-prize" style="font-size:1.2rem;font-weight:700;color:#FFD700;margin-bottom:10px;">üí∞ Weekly Contest: $500 Prize Pool</div>
        <p>Entry: FREE | Deadline: Sunday 1:00 PM EST</p>
      </div>

      <div class="lineup-grid">
        <div class="position-slot" data-position="QB" ondrop="drop(event)" ondragover="allowDrop(event)">
          <div class="position-label">QB</div><div class="position-hint">Quarterback</div>
        </div>
        <div class="position-slot" data-position="WR" ondrop="drop(event)" ondragover="allowDrop(event)">
          <div class="position-label">WR</div><div class="position-hint">Wide Receiver</div>
        </div>
        <div class="position-slot" data-position="RB" ondrop="drop(event)" ondragover="allowDrop(event)">
          <div class="position-label">RB</div><div class="position-hint">Running Back</div>
        </div>
        <div class="position-slot" data-position="FLEX" ondrop="drop(event)" ondragover="allowDrop(event)">
          <div class="position-label">FLEX</div><div class="position-hint">RB/WR/TE</div>
        </div>
      </div>

      <div class="lineup-power">
        <div>Total Lineup Power</div>
        <div class="total-power" id="totalPower">0</div>
      </div>

      <button class="submit-lineup" id="submitBtn" onclick="submitLineup()" disabled>SUBMIT LINEUP</button>
    </div>

    <div class="binder-section">
      <h2 class="section-title">üîó Wallet & Cards</h2>

      <div class="wallet-connection">
        <button class="connect-wallet-btn" id="connectWalletBtn" onclick="connectWallet()">Connect Wallet</button>
        <div class="wallet-status" id="walletStatus">No wallet connected</div>
      </div>

      <div class="my-binder">
        <div id="loadingCards" style="text-align:center;color:rgba(255,255,255,.7);padding:40px;display:none;">Loading your card collection...</div>
        <div id="noCards" style="text-align:center;color:rgba(255,255,255,.7);padding:40px;display:none;">No Breakaway Rush cards found in your wallet</div>
        <div class="binder-grid" id="binderGrid"></div>
      </div>

      <div class="debug-section">
        <div class="debug-title">üîß Debug Info</div>
        <div class="debug-content" id="debugInfo">Click "Connect Wallet" to load cards...</div>
      </div>
    </div>
  </div>

  <script>
    // =================== CONFIG ===================
    const HELIUS_API_KEY = '9bf5e48a-ca0c-43b8-9bf4-19a84d2ec2ea';
    const HELIUS_RPC_URL = `https://mainnet.helius.xyz:8899/?api-key=${HELIUS_API_KEY}`;
    
    // Your Breakaway Rush collection address (update this with your actual collection)
    const COLLECTION_ADDRESS = 'YOUR_COLLECTION_ADDRESS_HERE';
    
    // For testing - your house wallet
    const TEST_WALLET = '5mwLJh6T6pg9cSr8rrjnpVWxxyeh65YkSdVFDGHHt1hK';

    // =================== STATE ===================
    let currentLineup = {};
    let walletConnected = false;
    let userWalletAddress = null;
    let stakedCards = new Set();
    let userCards = [];

    // =================== DEBUG ===================
    function debugLog(message, data = null) {
      console.log(message, data);
      const debugDiv = document.getElementById('debugInfo');
      const timestamp = new Date().toLocaleTimeString();
      let logMessage = `[${timestamp}] ${message}`;
      if (data) {
        logMessage += '\n' + JSON.stringify(data, null, 2);
      }
      debugDiv.textContent = (debugDiv.textContent === 'Click "Connect Wallet" to load cards...' ? '' : debugDiv.textContent + '\n') + logMessage;
      // Auto-scroll to bottom
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    // =================== HELIUS API INTEGRATION ===================
    async function fetchNFTsFromHelius(walletAddress) {
      debugLog('Fetching NFTs from Helius for wallet:', walletAddress);
      
      try {
        const url = `https://api.helius.xyz/v0/addresses/${walletAddress}/nfts?api-key=${HELIUS_API_KEY}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Helius API error: ${response.status}`);
        }
        
        const data = await response.json();
        debugLog(`Helius returned ${data.length} total NFTs`);
        
        // Filter for Breakaway Rush cards (you'll need to identify your collection)
        // This filters by name pattern - adjust based on your actual NFT names
        const breakawayCards = data.filter(nft => {
          const name = nft.name || '';
          // Adjust this filter based on your actual NFT naming convention
          return name.toLowerCase().includes('breakaway') || 
                 name.toLowerCase().includes('rush') ||
                 name.includes('BR#') ||
                 // Check if it's from your collection
                 (nft.collection && nft.collection.address === COLLECTION_ADDRESS);
        });
        
        debugLog(`Found ${breakawayCards.length} Breakaway Rush cards`);
        
        if (breakawayCards.length === 0 && data.length > 0) {
          debugLog('No Breakaway Rush cards found, showing ALL NFTs for testing');
          // For testing, show first 10 NFTs regardless of collection
          return data.slice(0, 10).map(parseHeliusNFT);
        }
        
        return breakawayCards.map(parseHeliusNFT);
        
      } catch (error) {
        debugLog('Error fetching from Helius:', error.message);
        throw error;
      }
    }

    function parseHeliusNFT(nft) {
      try {
        // Extract metadata from Helius response
        const tokenId = nft.mint || nft.id || `nft_${Date.now()}`;
        const name = nft.name || 'Unknown Player';
        const image = nft.imageUri || nft.image || 'https://via.placeholder.com/150';
        
        // Parse attributes to get position and power
        const attributes = nft.attributes || [];
        
        // Helper to find attribute value
        const getAttr = (traitType) => {
          const attr = attributes.find(a => 
            a.trait_type === traitType || 
            a.traitType === traitType ||
            a.key === traitType
          );
          return attr ? (attr.value || attr.trait_value) : null;
        };
        
        // Get position (default to FLEX if not found)
        let position = getAttr('Position') || getAttr('position') || getAttr('POSITION');
        if (!position) {
          // Try to infer from name
          if (name.includes('QB')) position = 'QB';
          else if (name.includes('WR')) position = 'WR';
          else if (name.includes('RB')) position = 'RB';
          else if (name.includes('TE')) position = 'TE';
          else position = 'FLEX';
        }
        position = position.toString().toUpperCase();
        
        // Get power rating
        const power = parseInt(
          getAttr('Power') || 
          getAttr('power') || 
          getAttr('Rating') || 
          getAttr('rating') || 
          '85', // default power
          10
        );
        
        // Get tier
        const tier = parseInt(
          getAttr('Tier') || 
          getAttr('tier') || 
          getAttr('Rarity') || 
          getAttr('rarity') || 
          '1',
          10
        );
        
        return {
          tokenId,
          mint: nft.mint,
          name,
          position,
          power,
          tier,
          image
        };
        
      } catch (error) {
        debugLog('Error parsing NFT:', error);
        return null;
      }
    }

    // =================== DND HELPERS ===================
    function allowDrop(ev){ 
      ev.preventDefault(); 
      ev.currentTarget.classList.add('drop-zone'); 
    }
    
    document.addEventListener('dragend', () => {
      document.querySelectorAll('.binder-card').forEach(c=>c.classList.remove('dragging'));
      document.querySelectorAll('.position-slot').forEach(s=>s.classList.remove('drop-zone'));
    });
    
    function drag(ev){
      const card = ev.target;
      if(card.classList.contains('staked')){ 
        ev.preventDefault(); 
        return; 
      }
      ev.dataTransfer.setData("text", ev.target.outerHTML);
      ev.dataTransfer.setData("cardId", ev.target.dataset.cardId);
      ev.dataTransfer.setData("tokenId", ev.target.dataset.tokenId);
      ev.dataTransfer.setData("position", ev.target.dataset.position);
      ev.dataTransfer.setData("power", ev.target.dataset.power);
      ev.target.classList.add('dragging');
    }
    
    function drop(ev){
      ev.preventDefault();
      ev.currentTarget.classList.remove('drop-zone');
      if(!walletConnected){ 
        alert('Please connect your wallet first'); 
        return; 
      }

      const cardPos = ev.dataTransfer.getData("position");
      const slotPos = ev.currentTarget.dataset.position;
      const cardPower = parseInt(ev.dataTransfer.getData("power"), 10);
      const cardId = ev.dataTransfer.getData("cardId");
      const tokenId = ev.dataTransfer.getData("tokenId");
      const cardHtml = ev.dataTransfer.getData("text");

      if(!isValidPosition(cardPos, slotPos)){ 
        alert(`Cannot place ${cardPos} in ${slotPos} slot`); 
        return; 
      }
      if(stakedCards.has(tokenId)){ 
        alert('This card is already in your lineup'); 
        return; 
      }

      if(currentLineup[slotPos]){ 
        unstakeCard(currentLineup[slotPos].tokenId); 
      }

      ev.currentTarget.innerHTML = '';
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      const cardEl = wrapper.firstChild;
      cardEl.style.transform = 'scale(0.8)';
      cardEl.onclick = () => removeFromLineup(slotPos);
      ev.currentTarget.appendChild(cardEl);
      ev.currentTarget.classList.add('filled');

      currentLineup[slotPos] = { cardId, tokenId, position: cardPos, power: cardPower };
      stakeCard(tokenId);
      updateTotalPower();
      checkLineupComplete();
    }
    
    function isValidPosition(cardPos, slotPos){ 
      return slotPos === 'FLEX' ? ['RB','WR','TE'].includes(cardPos) : cardPos === slotPos; 
    }
    
    function stakeCard(tokenId){
      stakedCards.add(tokenId);
      const el = document.querySelector(`[data-token-id="${tokenId}"]`);
      if(el){
        el.classList.add('staked'); 
        el.draggable = false;
        const badge = document.createElement('div'); 
        badge.className='staked-badge'; 
        badge.textContent='IN LINEUP'; 
        el.appendChild(badge);
      }
    }
    
    function unstakeCard(tokenId){
      stakedCards.delete(tokenId);
      const el = document.querySelector(`[data-token-id="${tokenId}"]`);
      if(el){ 
        el.classList.remove('staked'); 
        el.draggable = true; 
        el.querySelector('.staked-badge')?.remove(); 
      }
    }
    
    function removeFromLineup(slot){
      const c = currentLineup[slot]; 
      if(c) unstakeCard(c.tokenId);
      const s = document.querySelector(`[data-position="${slot}"]`);
      s.innerHTML = `<div class="position-label">${slot}</div><div class="position-hint">${slot==='QB'?'Quarterback':slot==='WR'?'Wide Receiver':slot==='RB'?'Running Back':'RB/WR/TE'}</div>`;
      s.classList.remove('filled');
      delete currentLineup[slot]; 
      updateTotalPower(); 
      checkLineupComplete();
    }
    
    function updateTotalPower(){ 
      const total = Object.values(currentLineup).reduce((sum,c)=>sum+c.power,0); 
      document.getElementById('totalPower').textContent = total; 
    }
    
    function checkLineupComplete(){ 
      const req=['QB','WR','RB','FLEX']; 
      const ok=req.every(p=>currentLineup[p]); 
      document.getElementById('submitBtn').disabled = !ok || !walletConnected; 
    }

    // =================== WALLET CONNECTION ===================
    async function connectWallet(){
      try {
        document.getElementById('debugInfo').textContent = '';
        debugLog('Starting wallet connection...');
        
        // Check for Phantom wallet
        if (window.solana && window.solana.isPhantom) {
          debugLog('Phantom wallet detected');
          
          const response = await window.solana.connect();
          userWalletAddress = response.publicKey.toString();
          walletConnected = true;
          
          debugLog('Connected to wallet:', userWalletAddress);
          
        } else {
          // Use test wallet for development
          debugLog('No Phantom wallet found, using test wallet');
          userWalletAddress = TEST_WALLET;
          walletConnected = true;
        }
        
        document.getElementById('connectWalletBtn').textContent = 'Wallet Connected';
        document.getElementById('connectWalletBtn').disabled = true;
        document.getElementById('walletStatus').textContent = `Connected: ${userWalletAddress.slice(0,6)}...${userWalletAddress.slice(-4)}`;
        
        await loadUserCards();
        checkLineupComplete();
        
      } catch(e) {
        console.error(e);
        debugLog('ERROR in connectWallet:', e.message);
        alert(`Error: ${e.message}`);
      }
    }
    
    async function disconnectWallet(){
      userWalletAddress=null; 
      walletConnected=false; 
      currentLineup={}; 
      stakedCards.clear(); 
      userCards=[];
      document.getElementById('connectWalletBtn').textContent='Connect Wallet';
      document.getElementById('connectWalletBtn').disabled=false;
      document.getElementById('walletStatus').textContent='No wallet connected';
      document.getElementById('binderGrid').innerHTML='';
      document.getElementById('loadingCards').style.display='none';
      document.getElementById('noCards').style.display='none';
      updateTotalPower(); 
      checkLineupComplete();
    }

    // =================== LOAD & DISPLAY CARDS ===================
    async function loadUserCards(){
      try {
        const loading = document.getElementById('loadingCards');
        const none = document.getElementById('noCards');
        const grid = document.getElementById('binderGrid');
        
        loading.style.display='block'; 
        none.style.display='none'; 
        grid.innerHTML='';
        
        debugLog('Loading NFTs from Helius...');

        const cards = await fetchNFTsFromHelius(userWalletAddress);
        userCards = cards.filter(Boolean); // Remove any null cards
        loading.style.display='none';

        if(!userCards.length){ 
          none.style.display='block'; 
          debugLog('No cards found to display');
          return; 
        }
        
        debugLog(`Displaying ${userCards.length} cards`);
        displayCards(userCards);
        
      } catch(e) {
        console.error('loadUserCards error:', e);
        debugLog('ERROR in loadUserCards:', e.message);
        document.getElementById('loadingCards').style.display='none';
        document.getElementById('noCards').style.display='block';
      }
    }

    function displayCards(cards){
      const grid = document.getElementById('binderGrid');
      grid.innerHTML = '';
      
      for(const card of cards){
        const el = document.createElement('div');
        el.className='binder-card'; 
        el.draggable=true;
        el.dataset.position = card.position;
        el.dataset.power = String(card.power);
        el.dataset.tokenId = card.tokenId;
        el.dataset.cardId = card.mint;
        el.ondragstart = drag;
        el.innerHTML = `
          <div class="power-badge">${card.power}</div>
          <img src="${card.image}" alt="${card.name}" onerror="this.src='https://via.placeholder.com/150'">
          <div class="binder-card-name">${card.name}</div>
          <div class="binder-card-stats">${card.position} ‚Ä¢ Tier ${card.tier}</div>`;
        grid.appendChild(el);
      }
    }

    async function submitLineup(){
      if(Object.keys(currentLineup).length < 4){ 
        alert('Please fill all lineup positions'); 
        return; 
      }
      if(!walletConnected){ 
        alert('Please connect your wallet first'); 
        return; 
      }
      const total = Object.values(currentLineup).reduce((s,c)=>s+c.power,0);
      alert(`Lineup submitted! Total Power: ${total}`);
      console.log('Submitted lineup:', currentLineup);
      debugLog('Lineup submitted:', currentLineup);
    }
  </script>
</body>
</html>